- name: Update apt cache
  apt:
    update_cache: yes
    cache_valid_time: 3600

- name: Install gnupg
  ansible.builtin.apt:
    name:
      - curl
      - wget
      - software-properties-common
      - gnupg2
      - apt-transport-https
      - openjdk-17-jre-headless
      - lsb-release
      - ca-certificates
    state: present

- name: Download OpenSearch public key
  ansible.builtin.shell: "curl -fsSL https://artifacts.opensearch.org/publickeys/opensearch-release.pgp | gpg --dearmor -o /etc/apt/keyrings/opensearch.gpg"

- name: Add OpenSearch repository
  ansible.builtin.shell: "echo 'deb [signed-by=/etc/apt/keyrings/opensearch.gpg] https://artifacts.opensearch.org/releases/bundle/opensearch/3.x/apt stable main' | tee /etc/apt/sources.list.d/opensearch-3.x.list"

- name: Update apt cache
  ansible.builtin.apt:
    update_cache: yes

- name: Install OpenSearch
  ansible.builtin.apt:
    name: opensearch
    state: present
  environment:
    OPENSEARCH_INITIAL_ADMIN_PASSWORD: "{{ opensearch_admin_password }}"

- name: Copy opensearch config
  ansible.builtin.copy:
    src: opensearch.yml
    dest: /etc/opensearch/opensearch.yml

- name: Start opensearch
  ansible.builtin.systemd_service:
    name: opensearch
    state: restarted
    enabled: true